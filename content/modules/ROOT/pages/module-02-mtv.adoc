= 기존 가상 머신 마이그레이션

== 소개

이 실습 섹션에서는 https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7/[Migration Toolkit for Virtualization^] (MTV)를 사용하여 VMware vSphere에서 OpenShift로 가상 머신을 가져옵니다. 마이그레이션 툴킷은 두 가지 "모드"의 가져오기를 지원합니다:

* 콜드 마이그레이션은 마이그레이션을 시작하기 전에 원본(소스) 가상 머신을 종료합니다. 이는 기본 마이그레이션 유형입니다.
* 웜 마이그레이션은 원본(소스) 가상 머신이 계속 실행 중인 상태에서 데이터를 복사합니다. 대부분의 데이터가 복사되면 VM을 종료하고 나머지 데이터를 대상에 복사합니다. 이후 새 VM을 시작할 수 있으며, 이를 통해 VM이 실행하는 애플리케이션의 다운타임이 훨씬 단축됩니다.

[NOTE]
====
**Migration Toolkit for Virtualization**은 이미 OperatorHub에서 제공되는 오퍼레이터를 통해 클러스터에 이미 배포되어 있습니다.
====

MTV 오퍼레이터 설치 및 구성 방법은 다음 문서를 참고하세요: https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7/html/installing_and_using_the_migration_toolkit_for_virtualization/installing-the-operator_mtv[링크^].

MTV를 직접 구성하고자 하는 경우, 다음 링크에서 각각의 환경에 대한 요구사항을 확인하세요:

* https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#openstack-prerequisites_mtv[OpenStack^]
* https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#rhv-prerequisites_mtv[Red Hat Virtualization^]
* https://docs.redhat.com/en/documentation/migration_toolkit_for_virtualization/2.7/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#vmware-prerequisites_mtv[VMware vSphere^]


.*목표*

* VMware vSphere 환경 살펴보기
* Migration Toolkit for Virtualization(MTV)의 구성 확인
* 마이그레이션 계획 생성
* VM을 OpenShift Virtualization으로 마이그레이션
* 인터렉티브 데모를 통해 고급 기능 확인

[[prerequisites]]
== 마이그레이션 사전 요구사항

모든 마이그레이션에 다음 사전 요구사항이 적용됩니다:

* ISO 이미지 및 CD-ROM 디스크는 마운트 해제 되어 있어야 합니다.
* 각 NIC는 IPv4 또는 IPv6 주소 중 하나 이상을 가지고 있어야 하며, 둘 다 사용할 수도 있습니다.
* VM 운영 체제는 https://access.redhat.com/articles/973163#ocpvirt[OpenShift Virtualization^]의 게스트 OS로 인증 및 지원되어야 합니다.
* VM 이름은 소문자(a-z), 숫자(0-9), 하이픈(-)만을 포함해야 하며, 최대 253자까지 가능합니다. 첫 글자와 마지막 글자는 영숫자여야 하며, 대문자, 공백, 마침표(.), 특수문자 등은 사용할 수 없습니다.
* VM 이름은 OpenShift Virtualization 환경 내의 기존 VM 이름과 중복되어서는 안 됩니다.

[NOTE]
====
**Migration Toolkit for Virtualization**은 규칙을 준수하지 않는 VM에 자동으로 새 이름을 할당합니다. 이렇게 하면 마이그레이션이 문제없이 진행될 수 있습니다.
====

[[migrating_vms]]
== VMware에서 가상 머신 마이그레이션

OpenShift로 마이그레이션할 3계층 애플리케이션이 VMware에 배포되어 있습니다.

이 애플리케이션은 다음 네 개의 가상 머신으로 구성되어 있습니다.

* 트래픽을 웹 서버로 전달하는 HAproxy 시스템 1대
* MariaDB 데이터베이스를 실행하는 Linux 시스템 1대
* PHP 애플리케이션을 실행하며 데이터베이스에 연결하는 Microsoft Windows 서버 2대

이 실습에서는 이 중 세 개의 VM을 콜드 마이그레이션 방식으로 마이그레이션하게 됩니다.

[NOTE]
====
OpenShift는 *Service* 라는 리소스를 통해, SDN에 연결된 VM에 대한 네트워크 트래픽과 로드 밸런싱을 기본적으로 처리하므로 HAproxy(로드 밸런서) VM은 마이그레이션할 필요가 없습니다. 
====

=== VMware 환경 확인

vSphere의 데이터스토어 및 포트 그룹 등 리소스를 OpenShift의 스토리지 클래스 및 네트워크 연결 정의로 매핑하는 과정을 이해하기 위해 먼저 VMware 환경을 확인해 보겠습니다.

. VMware vCenter로 이동: https://{vcenter_console}[vCenter Console^]
. *Launch vSphere Client* 클릭
. 다음 자격 증명으로 로그인:
- *사용자:* {vcenter_full_user}
- *비밀번호:* {vcenter_password}

. 기본적으로 탐색 트리 상단의 *Inventory* 뷰로 이동되며, 해당 개체를 볼 권한이 없다는 메시지가 표시됩니다. 이는 현재 사용자 계정에서는 정상적인 현상입니다.
+
image::2025_spring/module-02-mtv/00_VMware_First_Login.png[link=self, window=blank, width=100%]

. 왼쪽에서 *Workloads* 아이콘을 클릭하고 탐색 트리를 확장하여 *Roadshow* 폴더와 그 하위의 4개 VM이 보일 때까지 탐색 트리를 확장하세요.
+
image::2025_spring/module-02-mtv/01_Workload_VM_List.png[link=self, window=blank, width=100%]
+
NOTE: 실제 실습 환경의 폴더 목록은 여기에 있는 이미지와 다를 수 있지만, Roadshow 폴더와 실습에 필요한 가상 머신(VM)을 찾을 수 있다면 실습을 진행할 수 있습니다.
+

. 상단의 *VMs* 아이콘을 클릭하여 각 가상 머신의 세부 정보를 확인합니다.
+
image::2025_spring/module-02-mtv/02_VM_Details.png[link=self, window=blank, width=100%]

. *Networks* 뷰로 이동한 후 트리를 확장하여 VM이 사용하는 포트 그룹을 확인합니다. 포트 그룹 이름은 **segment-migrating-to-ocpvirt**입니다.
+
image::2025_spring/module-02-mtv/03_vSphere_Network.png[link=self, window=blank, width=100%]

. 마지막으로 *Datastores* 뷰로 이동하여 *RS0x* 데이터센터에 연결된 데이터스토어를 확인합니다. *VMs* 서브탭을 선택하면 각 가상 머신이 사용하는 용량도 볼 수 있습니다.
+
image::2025_spring/module-02-mtv/04_vSphere_Datastore.png[link=self, window=blank, width=100%]

=== MTV에서 VMware 프로바이더 확인

VMware vSphere 및 그 아넹 있는 VM 확인을 마쳤다면 해당 브라우저 탭을 닫고 OpenShift 웹 콘솔로 돌아옵니다.

[NOTE]
====
**Migration Toolkit for Virtualization (MTV)**는 OpenShift Virtualization과는 별개의 도구이며, *가상화* 관점에서는 접근할 수 없습니다.
====

. 왼쪽 메뉴에서 **가상화** 클릭 후 드롭다운에서 **관리자**를 선택합니다.
+
image::2025_spring/module-02-mtv/05_Admin_Persona.png[link=self, window=blank, width=100%]

. 왼쪽 메뉴에서 *마이그레이션* -> **Providers for virtualization**으로 이동합니다.

. 상단에서 프로젝트를 **mtv-{user}**로 선택합니다.
+
image::2025_spring/module-02-mtv/06_MTV_Providers.png[link=self, window=blank, width=100%]

[NOTE]
====
MTV 2.4 이상 버전은 프로젝트/네임스페이스를 인식하므로 관리자 권한이 필요하지 않습니다. 애플리케이션 팀이나 VM 사용자에게 VM 가져오기 권한을 위임하여 스스로 마이그레이션을 진행할 수 있습니다!
====

기본적으로 **OpenShift Virtualization**을 대상 플랫폼으로 나타내는 **host**라는 프로바이더가 있습니다.

또한, 실습에서는 이미 **vmware**라는 추가 프로바이더가 구성되어 있으며, 해당 공급자의 엔드포인트 주소는 방금 살펴본 VMware vSphere 클러스터입니다.

=== 마이그레이션 계획 생성

환경 및 프로바이더를 확인했으니 이제 **Migration Plan**을 생성할 차례입니다. 이 계획에서는 VMware vSphere에서 Red Hat OpenShift Virtualization으로 마이그레이션할 VM을 선택하고 마이그레이션 실행 방법에 대한 세부 사항을 지정합니다.

. 왼쪽 메뉴에서 *Migration* -> **Plans for virtualization**으로 이동 후 **Create Plan**을 클릭합니다.
+
image::2025_spring/module-02-mtv/07_Create_VMWARE_Plan.png[link=self, window=blank, width=100%]

. 먼저 플랜 이름을 생성하라는 메시지가 표시됩니다. 해당 필드에 *move-webapp-vmware* 값을 입력하세요. 마이그레이션에 선택된 프로젝트가 mtv-{user} 인지 확인하고, *VMware* 타일을 클릭하여 마이그레이션할 소스 공급자를 선택합니다.
+
image::2025_spring/module-02-mtv/08_VMware_Source_Provider.png[link=self, window=blank, width=100%]

. 페이지가 업데이트되면 사용자 계정 **{user}**이 액세스 권한을 가진 환경 내 가상 머신 목록이 표시됩니다.
+
image::2025_spring/module-02-mtv/09_VM_Search.png[link=self, window=blank, width=100%]

. 다음 화면에서 아래 세 개의 VM을 선택합니다.

* database-{user}
* winweb01-{user}
* winweb02-{user}
+
image::2025_spring/module-02-mtv/10_VM_Select_VMWARE_Plan.png[link=self, window=blank, width=100%]

. **Next**를 클릭합니다.

. 마이그레이션 계획에 대한 세부 정보를 입력합니다. 일부 항목은 자동으로 채워지지만, 아래 값으로 수정하세요.

* *Plan name*: move-webapp-vmware
* *Target provider*: host
* *Target namespace*: vmexamples-{user}
* *Network map*: Pod Networking
* *Storage map*: ocs-external-storagecluster-ceph-rbd
+
image::2025_spring/module-02-mtv/11_Create_Migration_Plan.png[link=self, window=blank, width=100%]
+
[NOTE]
====
경우에 따라 네트워크 및 스토리지 맵은 검색된 가상 머신이 소스 (원본) 공급자에서 현재 사용 중인 네트워크와 데이터스토어를 자동으로 감지합니다. 그렇지 않은 경우 해당 매핑을 생성하고 OpenShift 측의 위 값과 일치하는지 확인해야 합니다.
====

. *Create migration plan* 버튼을 클릭합니다.

. 새로운 화면으로 이동하게 되며, 해당 화면에서 마이그레이션 계획이 현재 검증 중(being validated)이며 '준비되지 않음(Not Ready)' 상태임을 확인할 수 있습니다.
+
image::2025_spring/module-02-mtv/12_Migration_Plan_Unready.png[link=self, window=blank, width=100%]

. 몇 분 후 계획이 *Ready* 상태가 되면 파란색 "Start Migration" 버튼을 클릭합니다.
+
image::2025_spring/module-02-mtv/13_Migration_Plan_Ready.png[link=self, window=blank, width=100%]

. 마이그레이션 시작 확인창이 뜨면 *Start* 버튼을 클릭합니다.
+
image::2025_spring/module-02-mtv/14_Confirm_Migrate_Start.png[link=self, window=blank, width=100%]

. 계획 상태가 *'Running'* 으로 바뀌고 , *'Status'* 필드 아래에 회전하는 아이콘이 나타나며 마이그레이션 진행 상황이 백분율로 표시됩니다.
+
image::2025_spring/module-02-mtv/15_VMs_Migrating.png[link=self, window=blank, width=100%]

. Virtual Machines 탭을 클릭하면 마이그레이션 계획 진행 상황에 대한 자세한 정보가 포함된 페이지가 표시됩니다.
+
image::2025_spring/module-02-mtv/16_VMs_Migrating_Details.png[link=self, window=blank, width=100%]

. 마이그레이션 중인 각 VM 이름 옆에 있는 드롭다운 화살표를 클릭하면 마이그레이션 프로세스 단계에 대한 자세한 정보를 확인할 수 있습니다. *database-{user}* 옆에 있는 화살표를 클릭하면 세부 정보가 확장됩니다.
+
image::2025_spring/module-02-mtv/17_VM_Migration_Stages.png[link=self, window=blank, width=100%]

[IMPORTANT]
====
가상 머신 마이그레이션에는 10Gbps 네트워크가 권장되지만, 저희 시뮬레이션 환경에는 해당 네트워크가 구축되어 있지 않습니다. 또한, 여러 참가자가 동일한 작업을 병렬로 수행하는 경우 실제 환경보다 마이그레이션 속도가 훨씬 느릴 수 있습니다. 마이그레이션이 완료될 때까지 다소 시간이 걸릴 수 있으니 양해 부탁드립니다. 마이그레이션이 백그라운드에서 진행되는 동안 로드쇼의 다른 섹션을 계속 진행하셔도 됩니다. 마이그레이션된 가상 머신 작업은 다음 모듈에서 다시 진행하겠습니다.
====

이러한 가상 머신을 마이그레이션하는 데는 현재 실습에 참여하는 사용자 수에 따라 상당한 시간이 소요될 수 있습니다. 마이그레이션 계획이 완료될 때까지 다음 대화형 비디오 섹션이나 다음 모듈로 이동하셔도 좋습니다. 마이그레이션된 가상 머신은 이후 모듈에서 사용하겠습니다.

[[interactive_demos]]
== 고급 기능을 알아보기 위한 인터렉티브 데모

이번 실습에서 콜드 마이그레이션이 완료될 때까지 기다리는 동안, MTV에서 사용할 수 있는 몇 가지 고급 마이그레이션 옵션을 소개해 드리고자 합니다. 이 섹션에서는 마이그레이션 과정 중 가상 머신의 자동 재구성 방법과 마이그레이션 작업 중 다운타임을 최소화하는 웜 마이그레이션 방법을 다룹니다.

아래 섹션을 살펴보시고 인터랙티브 데모 비디오도 시청해 보시기 바랍니다.

=== 자동회된 구성 후크 (Config Hooks)

자동화된 구성 후크는 MTV에 내장된 매우 강력하고 유용한 기능입니다.

구성 후크는 가상화 마이그레이션 툴킷의 기능으로 제공되며, 마이그레이션 프로세스가 완료되기 전이나 후에 가상 머신의 속성을 수정하기 위한 사전 또는 사후 구성 후크로 설정할 수 있습니다. Ansible 자동화 기능을 활용하여 YAML 형식의 플레이북을 통해 원하는 작업을 수행하지만, https://www.redhat.com/en/hybrid-cloud-solutions/automation?sc_cid=RHCTN0250000435827&gad_source=1&gad_campaignid=20322566154&gbraid=0AAAAADsbVMRTUlnZMtmJPEadK_tiBW92m&gclid=EAIaIQobChMIqt2m1oHxjAMVjnFHAR1rXhMLEAAYASAAEgIdAfD_BwE&gclsrc=aw.ds[Ansible Automation Platform^] 에 대한 별도의 구독이 필요하지 않습니다. 대신, 마이그레이션 프로세스 중에 대상 가상 머신에 대해 제공된 플레이북을 실행하는 별도의 *ansible-runner* Pod 내에서 실행됩니다.

이러한 자동화된 작업은 원본 하이퍼바이저에서 정상적으로 작동했던 가상 머신이 OpenShift 가상화 환경에서도 예상대로 작동하도록 보장하는 데 매우 유용합니다.

가상 머신의 파일을 편집하는 것과 같은 간단한 작업부터 하드웨어 장치 구성을 업데이트하는 것과 같은 복잡한 작업까지 수행할 수 있습니다.

아래 인터렉티브 데모를 통해 두 가지 예시를 모두 확인해 보세요.

.데모 단계는 다음과 같습니다:
* 원격 ESXi 호스트에서 가상 머신을 검색하고 콜드 마이그레이션 계획을 구성합니다.
* 사전-마이그레이션 후크를 사용하여 네트워크 어댑터를 VMware 기본 형식에서 OpenShift 가상화용 VirtIO 형식으로 재구성하고, 마이그레이션 프로세스 시작 시간을 기록하는 텍스트 파일을 생성합니다.
* 사후-마이그레이션 후크를 사용하여 네트워크 어댑터 구성을 정리하고, 마이그레이션 프로세스 완료 시간을 기록하는 또 다른 텍스트 파일을 생성합니다.
* 실행 중인 가상 머신이 성공적으로 마이그레이션되었는지, 그리고 변경 사항이 시작 후에도 유지되는지 확인합니다.

++++
<iframe
  src="https://demo.arcade.software/cfhTjX94HcFjuP2pX0Lm?embed&embed_mobile=inline&embed_desktop=inline&show_copy_link=true"
  width="100%"
  height="600px"
  frameborder="0"
  webkitallowfullscreen
  mozallowfullscreen
  allowfullscreen
>
</iframe>
++++

=== 웜 마이그레이션

MTV의 기본 마이그레이션 유형은 원본 가상 머신을 마이그레이션 기간 동안 완전히 종료해야 하는 콜드 마이그레이션이지만, 중요한 워크로드를 처리해야 하는 많은 조직에서는 가상 머신 마이그레이션을 위해 장시간 다운타임을 허용할 수 없습니다. 이러한 워크로드를 위해 MTV는 웜 마이그레이션도 지원합니다.

웜 마이그레이션은 소스 하이퍼바이저의 변경 블록 추적(CBT) 기술을 활용하여 수행됩니다. CBT는 백업 및 재해 복구 작업 시 데이터 전송량을 줄이기 위해 자주 사용됩니다. 가상 머신에서 CBT가 활성화되면 게스트의 스냅샷이 정기적으로 생성되어 VM 디스크의 변경 사항을 기록합니다. VM을 마이그레이션할 시점이 되면 게스트의 초기 복사본이 실행 중인 상태에서 전송됩니다. 이를 통해 머신이 계속 작동 중인 상태에서 다운타임 없이 대량의 머신 데이터를 전송할 수 있습니다. 장애 발생 가능 시간을 예약할 수 있는 경우, MTV는 게스트 OS를 종료하고 변경된 CBT 스냅샷 데이터를 전송하는 전환 작업을 트리거하여 VM의 다운타임을 훨씬 단축합니다.

.데모 단계는 다음과 같습니다:
* 소스 하이퍼바이저에서 실행 중인 Windows 및 Linux 가상 머신을 살펴봅니다.
* 가상화 공급자를 위한 마이그레이션 툴킷 구성 방식을 검토합니다.
* 전환 단계에서 중지되는 웜 마이그레이션 계획을 생성하고 실행합니다.
* 게스트가 여전히 실행 중인지 확인한 후 전환 작업을 시작합니다.
* 마이그레이션 계획이 완료된 후 환경을 살펴봅니다.

++++
<iframe
  src="https://demo.arcade.software/XavEz1uQrK12baAJqYnm?embed&embed_mobile=tab&embed_desktop=inline&show_copy_link=true"
  width="100%"
  height="600px"
  frameborder="0"
  webkitallowfullscreen
  mozallowfullscreen
  allowfullscreen
>
</iframe>
++++

[[migration_wrapup]]
== 마이그레이션 마무리

. 몇 분 후 마이그레이션이 성공적으로 완료된 것을 확인할 수 있습니다.
+
image::2025_spring/module-02-mtv/18_Completed_VMWARE_Plan.png[link=self, window=blank, width=100%]

. 선택된 가상 머신들이 OpenShift 가상화 환경으로 성공적으로 마이그레이션되었습니다.

== 요약

이 섹션에서는 MTV(Migration Toolkit for Virtualization)를 살펴보고, 이를 활용하여 기존 VMware vSphere 환경의 가상 머신을 OpenShift 가상화 환경으로 마이그레이션하는 방법을 알아보았습니다. 또한, 특정 마이그레이션 시나리오에서 활용할 수 있는 고급 기능을 보여주는 인터렉티브 데모도 시청했습니다.

MTV 외에도 현재 사용 가능한 다른 두 가지 마이그레이션 툴킷이 있습니다. 이러한 툴킷들을 조합하여 조직의 요구 사항에 따라 다양한 유형의 워크로드를 OpenShift 클러스터로 또는 클러스터 내에서 마이그레이션할 수 있습니다.

* https://docs.redhat.com/en/documentation/migration_toolkit_for_applications/7.2/html/introduction_to_the_migration_toolkit_for_applications/index[Migration Toolkit for Applications^] - 대규모 애플리케이션 현대화를 위해 컨테이너 및 쿠버네티스로의 전환을 가속화 하는 도구
* https://https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/migration_toolkit_for_containers/about-mtc[Migration Toolkit for Containers^] - 상태 저장 애플리케이션 워크로드를 OpenShift 클러스터 간에 마이그레이션하는 도구

다른 마이그레이션 툴킷에 대한 자세한 내용은 Red Hat 담당 영업 팀에 문의하십시오.
