= 가상 머신 및 애플리케이션 작업

== 소개

본 실습 섹션에서는 OpenShift 가상화 환경에서 가상 머신을 관리할 때 많은 관리자가 필요로 하는 Day-2 운영 작업을 다룹니다. 이번 로드쇼를 통해 습득한 OpenShift 환경에서의 가상 머신 작동 방식에 대한 이해를 바탕으로, 이 섹션의 작업을 완료할 것입니다. 특히, 이번 로드쇼 초반에 VMware vSphere에서 가져온 세 대의 가상 머신을 사용하여, 해당 서버에 호스팅된 애플리케이션이 OpenShift 가상화 환경에서 실행되는 그대로 접근할 수 있도록 몇 가지 간단한 구성 변경을 수행할 것입니다. 이를 위해 OpenShift SDN Pod 네트워크에서 기본적으로 사용되는 서비스/라우트 방식을 통해 애플리케이션을 노출하여 클러스터 외부에서도 애플리케이션에 접근할 수 있도록 할 것입니다. 이렇게 하면 가상 머신에 있는 애플리케이션을 직접 노출함으로써 가상 머신 관리에 더욱 현대적인 접근 방식을 제공할 수 있습니다.

[[service_route]]
== 서비스/라우트(Service/Route)를 사용하여 애플리케이션 노출

기본적으로 가상 머신은 SDN에 연결되어 있어 네트워크의 다른 부분에 편리하게 접근할 수 있습니다. 하지만 OpenShift 클러스터 내의 가상 머신 및 다른 파드들이 가상화된 애플리케이션을 찾아 연결하는 데 어려움을 겪을 수 있습니다. 이 문제를 해결하기 위해 두 개의 Windows 기반 웹 서버에 걸쳐 연결을 분산하는 **서비스**를 사용하고, 각 서비스에 대한 DNS 항목을 생성한 다음, 외부 클라이언트가 가상 머신에 호스팅된 애플리케이션에 접근할 수 있도록 **라우트**를 생성합니다.

IMPORTANT: 
*'기존 가상 머신 마이그레이션'* 모듈을 아직 완료하지 않았다면 먼저 해당 모듈을 완료하는 것이 좋습니다. 모듈을 완료하지 않았거나 마이그레이션 프로세스가 아직 진행 중인 경우, *vmimported-{user}* 프로젝트에 있는 미리 준비된 가상 머신을 사용할 수 있습니다. 미리 가져온 가상 머신을 사용하는 경우, 아래 예제에서 *vmexamples-{user}* 네임스페이스를 모두 **vmimported-{user}**로 바꿔야 합니다.

=== 서비스(Services) 소개

이 **서비스**는 트래픽의 출발지/도착지를 식별하고 레이블을 기반으로 클라이언트를 엔드포인트로 연결합니다. 현재 VM에는 아직 레이블이 할당되지 않았습니다.

가상 머신을 서비스에 성공적으로 연결하려면 다음 단계를 수행해야 합니다.

* 가상 머신에 레이블을 추가합니다. 두 Windows IIS 서버는 동일한 로드 밸런서 뒤에 있으므로 동일한 레이블을 사용합니다.
* 클러스터의 다른 워크로드에서 두 개의 Windows IIS 서버를 사용할 수 있도록 서비스를 생성합니다. OpenShift는 서비스 이름을 DNS 이름으로 사용하여 로드 밸런서를 내부적으로 액세스할 수 있도록 자동으로 설정합니다.
* **라우트**를 생성하여 OpenShift 외부에서 서비스를 이용할 수 있도록 하세요 .

먼저 OpenShift Virtualization GUI에서 가상 머신의 정의를 수정하여 레이블을 추가하겠습니다.

=== 가상 머신에 레이블 지정

왼쪽 열에서 **VirtualMachines**을 클릭하고 가져온 세 개의 가상 머신이 실행 중이 아니라면 **시작** 하세요. 오른쪽 트리 보기에서 *상태* 열을 기준으로 정렬하면 실행 중인지 쉽게 확인할 수 있습니다.
+
image::2025_spring/module-08-workingvms/11_Imported_VMs_List.png[link=self, window=blank, width=100%]
+
NOTE: *기존 가상 머신 마이그레이션* 모듈을 완료했다면 *vmexamples-{user}* 프로젝트를, 완료하지 않았다면 *vmimported-{user}* 프로젝트를 선택해야 합니다. 올바른 프로젝트를 선택했는지 확인하세요.

. *winweb01-{user}* VM을 선택하고 *YAML* 탭으로 이동합니다.
. *spec:* 섹션을 찾고 *template.metadata* 아래의 *labels* 섹션에 다음 내용을 추가하세요.

+
[source,yaml,role=execute]
----
env: webapp
----
+
IMPORTANT: 아래 스크린샷처럼 들여쓰기를 정확하게 맞춰야 합니다.
+
image::2025_spring/module-08-workingvms/12_Imported_VMs_YAML.png[link=self, window=blank, width=100%]

. VM *winweb02-{user}*에 대해서도 동일한 과정을 **반복**합니다.
. 구성 변경 후  *winweb01-{user}* 및 *winweb02-{user}* 가상 머신을 모두 재부팅해야 합니다.
+
NOTE: 각 가상 머신의 콘솔 탭에 접속하여 가상 머신이 제대로 작동하는지 확인하세요.

=== 서비스 생성

. 왼쪽 메뉴에서 **네트워킹**을 확장하고 서비스를 클릭합니다. 나타나는 화면에서 오른쪽 모서리에 있는 **서비스 생성** 버튼을 클릭합니다.
+
image::2025_spring/module-08-workingvms/13_Navigate_Service.png[link=self, window=blank, width=100%]

. YAML 파일을 다음 내용으로 교체합니다.
+
[source,yaml,role=execute,subs="attributes"]
----
apiVersion: v1
kind: Service
metadata:
  name: webapp
  namespace: vmexamples-{user}
spec:
  selector:
    env: webapp
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
----
+
IMPORTANT: 서비스(Service) YAML에서 가상 머신의 네임스페이스가 올바른지 확인하세요. (예를 들어 가져오기가 미리 완료되어 있던 가상 머신을 사용 중이시라면 네임스페이스는 위에 적힌 **vmexamples-{user}**가 아니라 **vmimported-{user}**로 수정하셔야 합니다.)
+
image::2025_spring/module-08-workingvms/14_Service_YAML.png[link=self, window=blank, width=100%]

. 하단의 '생성' 버튼을 클릭하세요. YAML 파일이 저장되었다는 알림이 표시됩니다.
. 새로 생성된 *webapp* 서비스의 세부정보 페이지에서 *Pod 선택기* 링크를 찾아 클릭합니다.
+
image::2025_spring/module-08-workingvms/15_Imported_VMs_PodSelector.png[link=self, window=blank, width=100%]

. 두 개의 Windows VM이 서비스에서 올바르게 식별되고 대상으로 지정되었는지 확인합니다.
+
image::2025_spring/module-08-workingvms/16_Imported_VMs_Pods.png[link=self, window=blank, width=100%]

=== 라우트 생성

이제 Windows IIS 서버는 OpenShift 클러스터 내부에서 접근 가능합니다. 다른 가상 머신은 서비스 이름과 네임스페이스를 조합하여 생성되는 DNS 이름 **webapp.vmexamples-{user}**를 사용하여 해당 서버에 접근할 수 있습니다. 하지만 이러한 웹 서버는 애플리케이션의 프런트엔드 역할을 하므로 외부에서도 접근 가능하도록 해야 합니다. 이를 위해 **라우트**를 사용하여 공개적으로 노출할 것입니다.

. 왼쪽 탐색 메뉴에서 *네트워킹* 메뉴 아래쪽, *Routes* 옵션을 클릭합니다. 화면 중앙에 있는 *Route 만들기* 버튼을 클릭합니다.
+
image::2025_spring/module-08-workingvms/17_Route_Navigation.png[link=self, window=blank, width=100%]

. 아래 정보를 사용하여 양식을 작성하고, 아래로 스크롤하여 완료되면 '생성'을 클릭하세요.
+
.. *이름*: *route-webapp*
.. *서비스*: *webapp*
.. *대상 포트*: *80 -> 80 (TCP)*
.. *보안*: *안전한 경로(체크)*
.. *TLS 종료*: *Edge*
.. *안전하지 않은 트래픽*: *리디렉션*
+
image::2025_spring/module-08-workingvms/18_Create_Route.png[link=self, window=blank, width=100%]

. *위치* 필드에 표시된 주소로 이동하세요.
+
image::2025_spring/module-08-workingvms/19_Route_Access.png[link=self, window=blank, width=100%]

. 페이지가 로드되면 오류 화면이 표시됩니다. 무언가 문제가 발생한 것입니다. 이는 Windows 웹 서버가 마이그레이션 후, 데이터베이스 가상 머신에 연결할 수 없기 때문입니다.
+
image::2025_spring/module-08-workingvms/20_WebApp_Error.png[link=self, window=blank, width=100%]
+
NOTE: 연결 문제를 해결하려면, 웹 서버에서 데이터베이스 가상머신에 연결할 수 있도록 데이터베이스 가상 머신에 대한 서비스도 생성해야 합니다.
. 다시 한번, *네트워킹* → **Services**로 이동하여 **서비스 생성**을 누릅니다. YAML 파일을 다음 정의로 바꿉니다.
+
[source,yaml,role=execute,subs="attributes"]
----
apiVersion: v1
kind: Service
metadata:
  name: database
  namespace: vmexamples-{user}
spec:
  selector:
    vm.kubevirt.io/name: database-{user}
  ports:
  - protocol: TCP
    port: 3306
    targetPort: 3306
----
+
image::2025_spring/module-08-workingvms/21_Database_YAML.png[link=self, window=blank, width=100%]
+
IMPORTANT: 서비스 YAML에서 가상 머신의 네임스페이스(*vmexamples-{user}* 또는 *vmimported-{user}*)가 올바른지 확인하세요.
+
. YAML 코드를 붙여넣은 후, *만들기* 버튼을 클릭하세요.
. 웹 애플리케이션 URL을 브라우저에서 새로고침 하면, 마이그레이션된 웹 애플리케이션이 정상적으로 동작하는 것을 확인할 수 있습니다.
+
image::2025_spring/module-08-workingvms/22_WebApp_Success.png[link=self, window=blank, width=100%]

== 요약

이번 모듈에서는 VMware vSphere에서 OpenShift Virtualization 환경으로 마이그레이션한 가상 머신을 실제로 다뤄보았습니다. OpenShift의 기본 기능인 서비스와 라우트를 활용하여 클러스터 외부에서 접근할 수 있도록 구성함으로써, 보다 현대화된 방식으로 가상 머신 기반 애플리케이션을 운영하는 방법을 경험하였습니다.