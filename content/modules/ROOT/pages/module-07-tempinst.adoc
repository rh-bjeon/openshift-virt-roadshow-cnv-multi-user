= 템플릿 및 InstanceType 관리

== 소개

사전 구성된 Red Hat 가상 머신 템플릿은 `가상화` 항목의 `템플릿` 페이지에 나열되어 있습니다. 이러한 템플릿은 Red Hat Enterprise Linux, Fedora, CentOS, Microsoft Windows Desktop 및 Microsoft Windows Server의 다양한 버전에 사용할 수 있습니다. 각 Red Hat 관련 가상 머신 템플릿에는 운영 체제 이미지(부팅 소스), 운영 체제의 기본 설정, 종류(CPU 및 메모리), 워크로드 유형(서버)이 사전 구성되어 있습니다. 다른 운영 체제용 템플릿에는 OS 이미지가 포함되어 있지 않지만 해당 운영 체제에 권장되는 설정들이 사전 구성되어 있습니다.

*템플릿* 페이지에는 네 가지 유형의 가상 머신 템플릿이 표시됩니다:

* *Red Hat Supported* 템플릿은 Red Hat에서 완벽하게 지원합니다.
* *User Supported* 템플릿은 사용자가 복제하고 사용자 정의한 *Red Hat Supported* 템플릿입니다.
* *Red Hat Provided* 템플릿은 Red Hat에서 제한적으로 지원합니다.
* *User Provided* 템플릿은 사용자가 복제하고 사용자 정의한 *Red Hat Provided* 템플릿입니다.

[[prepare_templates_lab]]
== 실습 준비하기

. 곧 수행할 작업에는 몇 개의 추가 가상 머신(VM)을 프로비저닝해야 합니다. 준비 단계로, 공유 환경에 실습을 완료하는 데 필요한 충분한 리소스를 확보하기 위해 기존의 *fedora01* 및 *fedora02* 가상 머신을 종료해 주시기 바랍니다.
. 왼쪽 메뉴에서 `Virtualization` 관점으로 이동한 다음 `VirtualMachines` 를 클릭합니다.
. VM 워크로드를 호스팅하는 액세스 권한이 있는 각 프로젝트가 가운데 열에 트리 구조로 나열됩니다. (여기서 *vmimported-{user}* 및 *vmexamples-{user}* 프로젝트를 확장하여 가상 머신 상태를 확인해야 합니다.)
. VM 중 상태가 *Running* 으로 표시되는 VM이 ​​있으면 가운데 트리 열에서 해당 VM을 체크하고 `동작` 드롭다운 메뉴에서 `중지` 를 선택하여 VM들을 중지합니다.

이제 모든 가상 머신이 *Stopped* 상태가 되어야 합니다. 

image::2025_spring/module-07-tempinst/00_VMs_Stopped.png[link=self, window=blank, width=100%]

[[clone_customize_template]]
== 템플릿 복제 및 수정

기본적으로 Red Hat OpenShift Virtualization에서 제공하는 사전 구성된 템플릿은 사용자 정의할 수 없습니다. 하지만 템플릿을 복제하여 특정 워크로드에 맞게 조정하면 특정 워크로드에 필요한 특정 유형의 가상 머신을 더 쉽게 요청할 수 있습니다. 이 실습 섹션에서는 최종 사용자가 필요에 따라 사전 구성된 데이터베이스 서버를 사용할 수 있도록 템플릿을 생성하는 방법을 살펴보겠습니다.

. 먼저 왼쪽 메뉴에서 `템플릿` 을 클릭하고 프로젝트로 *openshift* 를 선택하세요. *openshift* 프로젝트가 표시되도록 *기본 프로젝트 표시* 버튼을 켜야 할 수도 있습니다.
+
image::2025_spring/module-07-tempinst/01_Project_Toggle.png[link=self, window=blank, width=100%]
+
image::2025_spring/module-07-tempinst/01_Template_List.png[link=self, window=blank, width=100%]

. 검색창에 *centos9* 를 입력하고 Enter 키를 누르세요. 나타나는 템플릿 목록에서 *centos-stream9-server-small* 템플릿을 찾으세요.
+
image::2025_spring/module-07-tempinst/02_Search_Centos9.png[link=self, window=blank, width=100%]

. *centos-stream9-server-small* 템플릿 이름을 클릭하면 기본 템플릿은 편집할 수 없다는 메시지와 함께 복제할지 묻는 메시지가 나타납니다. `새 사용자 지정 템플릿 만들기` 옵션을 클릭하세요.
+
image::2025_spring/module-07-tempinst/03_Create_Custom_Template.png[link=self, window=blank, width=100%]

. *템플릿 복제* 라는 팝업 창이 나타납니다. 다음 값을 입력하고 완료되면 `복제` 버튼을 클릭하십시오.
+
* *템플릿 이름:* centos-stream9-server-db-small
* *템플릿 프로젝트:* vmexamples-{user}
* *템플릿 표시 이름:* CentOS Stream 9 VM - Database Template Small
* *템플릿 제공자:* Roadshow {user}
+
image::2025_spring/module-07-tempinst/04_Clone_Template_Options.png[link=self, window=blank, width=100%]

. 이렇게 하면 템플릿의 `세부 정보` 페이지로 이동하며, 몇 가지 옵션을 사용자 지정할 수 있습니다. 페이지 하단에서 CPU와 메모리 항목을 찾아 연필 아이콘을 클릭하여 편집하세요.
+
image::2025_spring/module-07-tempinst/05_Clone_Details.png[link=self, window=blank, width=100%]

. [수정 필요!!] CPU와 메모리 용량을 편집할 수 있는 새 창이 나타납니다. 사용자 지정 템플릿의 경우 CPU 값을 2로, 메모리 값을 4GiB로 설정한 다음 `저장` 버튼을 클릭하세요.
+
image::2025_spring/module-07-tempinst/06_Edit_CPU_Mem.png[link=self, window=blank, width=100%]

. 다음으로 상단의 `Scripts` 탭을 클릭하고 *Cloud-init* 섹션에서 `편집` 버튼을 클릭합니다.
+
image::2025_spring/module-07-tempinst/09_Scripts_CloudInit.png[link=self, window=blank, width=100%]

. *Cloud-init* 대화 상자가 열리면 *다음을 사용하여 설정:* 항목의 `스크립트` 버튼을 클릭한 다음, YAML 편집기에 아래의 YAML 코드를 붙여넣기 합니다.
+
[source,yaml,role=execute]
----
userData: |-
  #cloud-config
  user: centos
  password: ${CLOUD_USER_PASSWORD}
  chpasswd: { expire: False }
  packages:
    - mariadb-server
  runcmd:
    - systemctl enable mariadb
    - systemctl start mariadb
----
+
image::2025_spring/module-07-tempinst/10_Cloud_Init_Script.png[link=self, window=blank, width=100%]

. `저장` 버튼을 클릭하면 녹색의 `저장됨` 메시지가 나타나고, 그 다음 `적용` 버튼을 클릭하세요.

. 이제 왼쪽 메뉴에서 `카탈로그` 항목을 클릭하고 `템플릿 카탈로그` 옵션을 선택한 다음 `사용자 템플릿` 을 선택하세요. 그러면 조금 전 생성한 템플릿이 타일 형태로 표시될 것입니다.
+
image::2025_spring/module-07-tempinst/11_User_Templates.png[link=self, window=blank, width=100%]

. 타일을 클릭하면 VM 시작 화면이 나타납니다. *가상 머신 빠른 생성* 버튼을 클릭하세요.
+
image::2025_spring/module-07-tempinst/12_Quick_Create_Template.png[link=self, window=blank, width=100%]

. 가상 머신이 부팅되면 *개요* 페이지에서 해당 가상 머신이 저희 템플릿을 기반으로 생성되었고, 저희가 정의한 추가 리소스가 포함되어 있음을 확인할 수 있습니다. 이제 *MariaDB* 가 제대로 설치되었는지 확인하기만 하면 됩니다.
+
image::2025_spring/module-07-tempinst/13_VM_From_Template.png[link=self, window=blank, width=100%]

. Click on the *Console* tab at the top and use the *Guest login credentials* that are provided and the *Copy* and *Paste to console* buttons to log into the console of the virtual machine.
+
image::2025_spring/module-07-tempinst/14_VM_Console.png[link=self, window=blank, width=100%]

. Once you are logged into the virtual machine, run the following command to test the install of MariaDB.
+
[source,sh,role=execute]
----
sudo mysql -u root
----
+
image::2025_spring/module-07-tempinst/15_MariaDB_Login.png[link=self, window=blank, width=100%]

. Hit *Ctrl-D* twice to log out of the VM.

[[create_win]]
== Create a Windows VM Template

In this segment of our lab, we will install Microsoft Windows Server 2019 using an ISO hosted on a web server. This represents one way to install an operating system to a virtual machine that takes advantage of the ability to source disks from many locations, including a web server, object storage, or other persistent volumes in the cluster.

This process can be streamlined after the initial operating system installation by creating a cloned root disk from a sysprepped virtual machine to use with other templates. 

NOTE: The specific process for preparing the guest operating system to be used as a template will vary, be sure to follow your organization's guidelines and requirements when preparing a template OS.

. From the left menu, navigate to *Catalog*, and click on the *Template catalog* tab near the top..

. Type the word *win* in the search bar, or scroll down until you find the *Microsoft Windows Server 2019 VM* tile.
+
image::2025_spring/module-07-tempinst/16_Windows_2k19_Tile.png[link=self, window=blank, width=100%]

. A dialog will appear showing the default configuration related to the template.
+
NOTE: Notice that there is intially no option to quick create this VM because there is no provided boot source. We must customize the VM to fit our needs.
+
image::2025_spring/module-07-tempinst/17_Windows_2k19_Dialog.png[link=self, window=blank, width=100%]
+
. In this dialog:
* Specify the name *win-sysprep*
* Enable the checkbox *Boot from CD*
* Choose *URL (creates PVC)* from the drop-down menu
* Specify the *image URL*: https://catalog-item-assets.s3.us-east-2.amazonaws.com/qcow_images/Windows2019.iso
* Reduce the CD disk size to *5 GiB*
* Keep the *Disk source* as *Blank* and the size set to the default value *60 GiB*
* Ensure the *Mount Windows drivers disk* checkbox is enabled. **This is required to install Windows systems, which will provide the drivers for VirtIO.**
+

. With the options filled out, we want to click on the *Customize VirtualMachine* button at the bottom to continue configuring our Template.
+
image::2025_spring/module-07-tempinst/18_Windows_2k19_Parameters.png[link=self, window=blank, width=100%]

. On the *Customize and create VirtualMachine* screen, click on the edit pencil by the *Boot mode* option. 
+
image::2025_spring/module-07-tempinst/19_Boot_Mode.png[link=self, window=blank, width=100%]

. When the *Boot mode* menu pops up, select the *BIOS* boot mode from the drop-down menu and click the *Save* button.
+
image::2025_spring/module-07-tempinst/19a_Boot_BIOS.png[link=self, window=blank, width=100%]

. Now click on the *Scripts* tab, and then scroll down to the *Sysprep* section and click on the *Edit* button.
+
image::2025_spring/module-07-tempinst/20_Customize_Scripts.png[link=self, window=blank, width=100%]

. A new window will pop up for you to create *Sysprep* actions for your new template.
+
image::2025_spring/module-07-tempinst/21_Sysprep.png[link=self, window=blank, width=100%]

. Copy and paste the following code block, which helps to automate the installation and configuration of the Windows server into the *autounattend.xml* section:
+
[source,xml,role=execute]
----
<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:schemas-microsoft-com:unattend">
  <settings pass="windowsPE">
    <component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <DiskConfiguration>
        <Disk wcm:action="add">
          <CreatePartitions>
            <CreatePartition wcm:action="add">
              <Order>1</Order>
              <Extend>true</Extend>
              <Type>Primary</Type>
            </CreatePartition>
          </CreatePartitions>
          <ModifyPartitions>
            <ModifyPartition wcm:action="add">
              <Active>true</Active>
              <Format>NTFS</Format>
              <Label>System</Label>
              <Order>1</Order>
              <PartitionID>1</PartitionID>
            </ModifyPartition>
          </ModifyPartitions>
          <DiskID>0</DiskID>
          <WillWipeDisk>true</WillWipeDisk>
        </Disk>
      </DiskConfiguration>
      <ImageInstall>
        <OSImage>
          <InstallFrom>
            <MetaData wcm:action="add">
              <Key>/IMAGE/NAME</Key>
              <Value>Windows Server 2019 SERVERSTANDARD</Value>
            </MetaData>
          </InstallFrom>
          <InstallTo>
            <DiskID>0</DiskID>
            <PartitionID>1</PartitionID>
          </InstallTo>
        </OSImage>
      </ImageInstall>
      <UserData>
        <AcceptEula>true</AcceptEula>
        <FullName>Administrator</FullName>
        <Organization>My Organization</Organization>
      </UserData>
      <EnableFirewall>false</EnableFirewall>
    </component>
    <component name="Microsoft-Windows-International-Core-WinPE" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <SetupUILanguage>
        <UILanguage>en-US</UILanguage>
      </SetupUILanguage>
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
  </settings>
  <settings pass="offlineServicing">
    <component name="Microsoft-Windows-LUA-Settings" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <EnableLUA>false</EnableLUA>
    </component>
  </settings>
  <settings pass="specialize">
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
  <settings pass="oobeSystem">
    <component name="Microsoft-Windows-International-Core" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
</unattend>
----

. Once the code is pasted, click the *Save* button on the dialog.
+
image::2025_spring/module-07-tempinst/22_Windows_2k19_Sysprep.png[link=self, window=blank, width=100%]

. With the Sysprep in place, click the *Create VirtualMachine* button at the bottom of the screen.
+
image::2025_spring/module-07-tempinst/23_Create_VirtualMachine.png[link=self, window=blank, width=100%]

. The Virtual Machine will start the provisioning process by downloading the ISO image, configuring, and starting the instance.
+
image::2025_spring/module-07-tempinst/24_Windows_2k19_Provisioning.png[link=self, window=blank, width=100%]

. This process may take a few minutes due to needing to download the boot ISO image. You can check on the progress of the download by clicking the *Diagnostics* tab.
+
image::2025_spring/module-07-tempinst/25_CD_Import.png[link=self, window=blank, width=100%]

. After a few moments, the virtual machine will start, and the status will change to *Running*. Click  to the *Console* tab to view the autoattend installation process:
+
image::2025_spring/module-07-tempinst/26_Windows_2k19_Console.png[link=self, window=blank, width=100%]

. Once the VM installation process is complete (provisioning will take 3-5 minutes, starting and configuring will take about 10 minutes), go ahead and power it off with the stop button.
+
image::2025_spring/module-07-tempinst/27_Stop_Button.png[link=self, window=blank, width=100%]

. With the machine powered down we want to make a clone of the root volume that we can use for future Windows template-based installs, without having to run through the customization process each time.

. On the left-side menu, click on *Storage* and then *PersistentVolumeClaims* to see a list of PVCs available in the *vmexamples-{user}* namespace. 

. Find the *win-sysprep* PVC created with our installation, and using the three-dot menu on the right select *Clone PVC*.
+
image::2025_spring/module-07-tempinst/28_Storage_PVC.png[link=self, window=blank, width=100%]

. On the menu that pops up, fill in the following options, then click the *Clone* button:
* *Name*: windows-2k19-sysprep-template
* *Access mode*:  Shared access (RWX) 
* *StorageClass*: ocs-external-storagecluster-ceph-rbd-immediate 
+
image::2025_spring/module-07-tempinst/29_Clone_Menu.png[link=self, window=blank, width=100%]

. Once this is saved, you can use it to quickly create Windows VMs in the future.

. Return to the *Catalog* menu item, and use this cloned PVC as a boot source for quick-creating new virtual machines by selecting the option for *PVC (clone PVC)* as the *Disk source*, and selecting the *Windows-2k19-Sysprep-Template* PVC as the *PVC name* to clone, and click the *Customize VirtualMachine* button to configure boot mode *BIOS* instead *UEFI*.
+
image::2025_spring/module-07-tempinst/30_Windows_Template.png[link=self, window=blank, width=100%]

. Configure BIOS and press *Create VirtualMachine*
+
image::2025_spring/module-07-tempinst/31_Windows_Template_BIOS.png[link=self, window=blank, width=100%]

. In a few moments the new Windows Server 2019 virtual machine will boot up from our cloned PVC.
+
image::2025_spring/module-07-tempinst/32_Windows_Template_Running.png[link=self, window=blank, width=100%]

[[instance_types]]
== Introduction to Instance Types

In order to simplify the deployment process for virtual machines, starting with OpenShift 4.14 the default configuration mechanism was changed to emphasize the use of *Instance Types*. An instance type is a reusable object where you can define resources and characteristics to apply to a new VM. You can define custom instance types or use the variety that are included when you install OpenShift Virtualization when provisioning your own VM. This is much more akin to what users experience when using a self-service catalog in popular cloud providers.

This section explores provisioning a VM using an instance type.

. To get started click on *Catalog* on the left-side menu. You will see the default catalog item is *InstanceType*.
+
image::2025_spring/module-07-tempinst/33_Left_Menu_Catalog.png[link=self, window=blank, width=100%]

. The first step in using an instance type is to select a volume to boot from. Similar to the templates that provide boot sources, these boot sources are available to use for guests provisioned with an InstanceType. You can see the included volumes by selecting the *openshift-virtualization-os-images* project, or you can upload your own with the *Add volume* button.
+
image::2025_spring/module-07-tempinst/34_Volume_Boot.png[link=self, window=blank, width=100%]

. Click on the *rhel9* boot volume to select it as the volume type to boot from. Selecting it will be denoted by a small vertical blue line to the left of the image name and the name itself being changed to a bold font.
+
image::2025_spring/module-07-tempinst/35_Select_RHEL9.png[link=self, window=blank, width=100%]

. Next you can select the instance type you would like to use. There are Red Hat provided instance types by default, or you can create your own for your specific use case. If you hover over a provided instance type you can see a description of its intended use.
+
image::2025_spring/module-07-tempinst/36_Select_InstanceType.png[link=self, window=blank, width=100%]
+
* The Red Hat provided instance types are intended for the following uses:
** *N series*: Designed for network intensive DPDK workloads like VNFs.
** *O series*: Specialized general purpose instance type with memory overcommit preconfigured.
** *CX series*: Designed for compute intensive workloads by requesting additional dedicated CPUs for additional function offload.
** *U series*: The most general purpose or "universal" instance type.
** *M series*: Designed for memory intensive workloads.

. Click on the *U series* tile to see a dropdown list of defined resources for general instance types. The default option here is *medium: 1 CPUs, 4 GiB Memory*. Select it. Again selection will be indicated by a blue line, and a bolding of the font for the instance type.
+
image::2025_spring/module-07-tempinst/37_InstanceType_Resources.png[link=self, window=blank, width=100%]

. The last section that needs to be completed when provisioning using an instance type is similar to the template section. You need to provide a name for the virtual machine, and select the storage class to be used for a backing disk. By default, a name will be generated for the VM, and the default storage class will be selected. When you are satisfied, click the *Create VirtualMachine* button.
+
image::2025_spring/module-07-tempinst/38_VM_Details.png[link=self, window=blank, width=100%]

. You will be directed to the virtual machine overview page, and see that the VM provisioned using an instance type is now up and running.
+
image::2025_spring/module-07-tempinst/39_VM_Overview.png[link=self, window=blank, width=100%]

[[cleanup]]
== Cleanup

To save resources for the next lab, please stop any VMs that you created in this module.

. Navigate to *Virtualization* perspective in the left-side menu and then click on *Virtualmachines*.
. Each project that you have access to that is hosting VM workloads will be listed in the center column treeview. (At a minimum you should expand projects *vmimported-{user}* and *vmexamples-{user}* to check virtual machine status.)
. If any VMs are showing a status of *Running*, highlight the VM in the center tree column, and select the *Stop* button or option from the *Actions* dropdown menu..

Now all VMs should be in *Stopped* state.

image::2025_spring/module-07-tempinst/40_All_Stopped.png[link=self, window=blank, width=100%]


== Summary

In this section we learned how to clone and customize an existing template to create one that can be used for specific workloads like databases. We also learned how to configure one of the existing Windows templates that exists without a boot source, and automate it's installation process, so we can create future deployments easily by cloning the installation PVC that was created with that VM. We also introduced how to make use of instance types to further customize our virtual machines for specific workloads for a more cloud-like experience.
