= 스토리지 관리

Red Hat OpenShift는 온프레미스 및 클라우드 환경 모두에서 다양한 유형의 스토리지를 지원합니다. OpenShift Virtualization은 워크로드가 실행되는 환경에서 지원되는 모든 컨테이너 스토리지 인터페이스(CSI) 프로비저너를 사용할 수 있습니다.

물리적 스토리지 시스템 예시: Dell/EMC, Fujitsu, Hitachi, NetApp, Pure Storage 등

소프트웨어 정의 스토리지 예시: IBM Fusion Data Foundation, OpenShift Data Foundation(ODF), Portworx 등

NOTE: 이 목록은 모든 지원되는 스토리지 솔루션을 포함하는 것은 아닙니다. 지원되는 모든 스토리지 솔루션에 대한 자세한 내용은 https://catalog.redhat.com/platform/red-hat-openshift/virtualization#virtualization-infrastructure[Red Hat EcoSystem Catalog^]를 참조하십시오.

이번 세션에서는 스토리지 공급자에게 스토리지를 요청하고 VM 디스크를 저장하는 데 사용되는 영구 볼륨 클레임(PVC)에 대해 살펴봅니다. 많은 스토리지 벤더는 장치의 스냅샷 및 클론 기능도 지원하므로, CSI 드라이버와 스토리지 장치에서 지원하는 기능을 스토리지 벤더에서 확인하십시오.

특히 OpenShift 가상화에 특화된 스토리지 프로토콜(예: NFS, iSCSI, FC 등)에는 제한이 없습니다. 클러스터 내 VM의 라이브 마이그레이션을 지원하기 위해 *RWX 액세스 모드* 가 `RWX 액세스 모드` 가 사용 가능해야 한다는 점만 요구됩니다. 그 외에는 조직의 VM 및 애플리케이션 요구 사항에 가장 적합한 스토리지를 선택하면 됩니다.

아래 그림은 Red Hat OpenShift에서 스토리지를 프로비저닝하는 CSI 워크플로를 보여줍니다.

image::2025_spring/module-04-storage/00_Disk_Concepts.png[link=self, window=blank, width=100%]

[[examine_pvc]]

== VM의 PVC 살펴보기

이번 실습에서는 방금 생성한 가상 머신 *fedora01*의 스토리지를 자세히 살펴보겠습니다.

. 먼저 왼쪽 메뉴에서 *스토리지* -> *영구 볼륨 클레임* 을 클릭합니다. *vmexamples-{사용자}* 네임스페이스에 있는지 확인하세요. 이전 섹션에서 *fedora01* 가상 머신을 생성할 때 만들어진 *fedora01* PVC가 표시될 것입니다.
+
image::2025_spring/module-04-storage/01_PVC_List.png[link=self, window=blank, width=100%]

. *fedora01* PVC를 클릭하면 VM을 지원하는 스토리지 볼륨에 대한 추가 정보가 표시되는 화면이 나타납니다.
+
. 다음은 영구 볼륨(PVC)에 대한 정보입니다:
.. PVC가 현재 성공적으로 바인딩되었습니다.
.. PVC의 요청된 용량 및 크기는 30GiB입니다.
.. PVC의 액세스 모드는 ReadWriteMany(RWX)입니다.
.. PVC의 볼륨 모드는 Block입니다.
.. 볼륨은 *ocs-external-storagecluster-ceph-rbd* 스토리지 클래스를 사용합니다.
+
image::2025_spring/module-04-storage/02_Fedora01_PVC_Details.png[link=self, window=blank, width=100%]

[[managing_snapshots]]
== 스냅샷 관리

OpenShift Virtualization은 CSI 스토리지 공급자의 스냅샷 기능을 활용하여 가상 머신의 디스크 스냅샷을 생성합니다. 이 스냅샷은 가상 머신이 실행 중일 때 "온라인"으로, 또는 가상 머신이 꺼져 있을 때 "오프라인"으로 생성할 수 있습니다. 가상 머신에 KVM 연동 패키지(qemu-tools)가 설치되어 있는 경우, 게스트 운영 체제를 자동으로 정지(quiescing)하는 옵션도 사용할 수 있습니다. (정지 기능을 사용하면 디스크 스냅샷이 게스트 파일 시스템의 일관된 상태를 나타내게 됩니다. 예를 들어 버퍼가 플러시되고 저널이 일관성을 유지합니다.)

디스크 스냅샷은 CSI에서 추상화되는 스토리지 구현에 따라 달라지므로, 성능 영향과 사용 용량은 스토리지 공급업체에 따라 달라집니다. 스토리지 공급업체에 문의하여 시스템에서 PVC 스냅샷을 관리하는 방법과 예상 성능에 미치는 영향을 확인하십시오.

IMPORTANT: 스냅샷 자체는 백업 또는 재해 복구 기능을 제공하지 않습니다. 스냅샷은 일반적으로 원본 물리 볼륨과 동일한 스토리지 시스템에 저장되기 때문에, 진정한 재난 상황에서 살아남기 위해서는 데이터를 다른 곳에 보관해야 합니다. 예를 들어, 다른 위치에 하나 이상의 사본을 저장하거나, 스토리지 시스템 자체의 장애를 극복하기 위해 원격 위치의 스토리지 시스템에 미러링하는 등의 조치가 필요합니다.

VM 스냅샷 기능을 통해 클러스터 관리자와 애플리케이션 개발자는 다음과 같은 작업을 수행할 수 있습니다.

* 새 스냅샷 생성
* 특정 VM에 연결된 모든 스냅샷 목록 보기
* VM을 스냅샷으로 복원
* 기존 VM 스냅샷 삭제

=== 스냅샷 생성 및 사용

. *가상화* 드롭다운 메뉴로 돌아가서 왼쪽 메뉴에서 *가상 머신*을 클릭합니다. 가운데 열에서 *vmexamples-{user}* 프로젝트를 확장하고 *fedora01* 가상 머신을 선택합니다.
+
image::2025_spring/module-04-storage/03_VM_Overview.png[link=self, window=blank, width=100%]

. 참고로 현재 개요 페이지에는 이 VM의 스냅샷이 없습니다.
+
image::2025_spring/module-04-storage/04_Snapshots_Overview.png[link=self, window=blank, width=100%]

. 페이지 상단의 *스냅 샷* 탭으로 이동하세요.
+
image::2025_spring/module-04-storage/05_Snapshot_Menu.png[link=self, window=blank, width=100%]

. *스냅샷 찍기*를 누르면 대화 상자가 열립니다.
+
image::2025_spring/module-04-storage/06_VM_Snapshot_Dialog.png[link=self, window=blank, width=100%]
+
NOTE: 스냅샷에 *cloudinitdisk*가 포함되지 않았다는 경고 메시지가 표시됩니다. 이는 초기 부팅에 사용되는 임시 디스크이기 때문에 발생하는 정상적인 현상입니다.

. 스냅샷에 대한 이름이 자동으로 생성됩니다. *저장*을 누르고 *상태*가 *Ready*로 표시될 때까지 기다리세요.
+
image::2025_spring/module-04-storage/07_VM_Snapshot_Taken.png[link=self, window=blank, width=100%]

. 점 세 개 메뉴를 누르면 가상 머신이 현재 실행 중이므로 *복원* 옵션이 비활성화(회색으로 표시)되어 있는 것을 확인할 수 있습니다.
+
image::2025_spring/module-04-storage/08_VM_Restore_Disabled.png[link=self, window=blank, width=100%]

. 다음으로 *콘솔* 탭으로 전환합니다. 로그인 후 가상 머신이 부팅되지 않도록 수정 작업을 진행할 것입니다.
+
image::2025_spring/module-04-storage/09_Console_Login.png[link=self, window=blank, width=100%]
+
NOTE: *사용자 이름*과 *암호* 옆에 복사 아이콘이 있고 *콘솔에 붙여넣기* 버튼도 모두 사용할 수 있어 로그인 과정이 훨씬 간편해집니다.

. 로그인 후 다음 명령어를 실행하세요:
+
[source,sh,role=execute]
----
sudo rm -rf /boot/grub2; sudo shutdown -r now
----
+
. 이 명령이 실행되면 가상 머신은 자동으로 다시 시작되지만, 더 이상 정상적으로 부팅할 수 없게 됩니다.
+
image::2025_spring/module-04-storage/10_Bootloader_Broken.png[link=self, window=blank, width=100%]
+
IMPORTANT: 이전 단계에서는 게스트 OS 내에서 운영 체제를 종료했습니다. 하지만 OpenShift Virtualization은 VM을 호스팅하는 Pod가 여전히 실행 중이므로 정책에 따라 기본적으로 운영 체제를 자동으로 다시 시작합니다. 이 동작은 전체적으로 또는 VM별로 변경할 수 있습니다.

. 오른쪽 상단의 *동작* 드롭다운 메뉴 또는 바로 가기 버튼을 사용하여 가상 머신을 *중지*하십시오. 정상적인 종료를 시도하고 가상 머신이 불안정한 상태가 되므로 이 과정은 시간이 오래 걸릴 수 있습니다. *동작* 드롭다운 메뉴를 다시 클릭하면 *강제 정지* 옵션이 나타납니다. 실습을 계속하려면 이 옵션을 사용하십시오.

. *개요* 탭을 클릭하여 VM이 중지되었는지 확인할 수 있습니다. 또한 최근에 생성한 스냅샷이 *스냅 샷* 타일에 표시된 것을 볼 수 있습니다.
+
image::2025_spring/module-04-storage/11_VM_Stopped_Snapshot.png[link=self, window=blank, width=100%]

. *스냅 샷* 타일에서 스냅샷 옆에 있는 점 3개 메뉴를 클릭하면 VM이 중지된 상태에서 *복원*이 더 이상 비활성화되지 않은 것을 확인할 수 있습니다. *복원*을 클릭하세요.
+
image::2025_spring/module-04-storage/12_VM_Restore.png[link=self, window=blank, width=100%]

. 표시되는 대화 상자에서 *복원*을 누르세요.
+
image::2025_spring/module-04-storage/13_VM_Restore_Dialog.png[link=self, window=blank, width=100%]

. 가상 머신 복원이 완료될 때까지 기다려 주세요. 복원 과정은 비교적 빠르게 진행됩니다. 상단의 *스냅 샷* 탭을 클릭하면 마지막 복원 작업에 대한 자세한 정보를 확인할 수 있습니다.
+
image::2025_spring/module-04-storage/14_VM_Restored.png[link=self, window=blank, width=100%]

. *개요* 탭으로 돌아가서 가상 머신을 시작하세요.
+
image::2025_spring/module-04-storage/15_VM_Start.png[link=self, window=blank, width=100%]

. *콘솔* 탭을 클릭하여 가상 머신이 다시 시작되어 운영 체제로 성공적으로 부팅되었는지 확인하십시오.
+
image::2025_spring/module-04-storage/16_VM_Running.png[link=self, window=blank, width=100%]

[[clone_vm]]
== 가상 머신 복제

가상 머신을 복제하면 자체적인 디스크 이미지를 스토리지로 사용하는 새 가상 머신이 생성되지만, 복제본의 구성 및 저장된 데이터는 대부분 원본 가상 머신과 동일합니다.

. *개요* 화면으로 돌아가서 *동작* 드롭다운 메뉴를 클릭하면 가상 머신 복제 옵션이 표시됩니다.
+
image::2025_spring/module-04-storage/17_Overview_Actions_Clone.png[link=self, window=blank, width=100%]

. Press *Clone* from the *Actions* menu, and a dialog will open. Name the cloned VM *fedora02*, and ensure that the checkbox to *Start VirtualMachine on clone* remains unchecked, then click *Clone*.
+
image::2025_spring/module-04-storage/18_VM_Clone_Dialog.png[link=self, window=blank, width=100%]

. A new VM is created, the disks are cloned and automatically the portal will redirect you to the new VM, and you can see the *Created* time as very recently.
+
image::2025_spring/module-04-storage/19_VM_Cloned.png[link=self, window=blank, width=100%]
+
IMPORTANT: The cloned VM will have the same identity as the source VM, which may cause conflicts with applications and other clients interacting with the VM. Use caution when cloning a VM connected to an external network or in the same project.

. Click on the *YAML* menu at the top of the screen, you will see that the name of the VM is *fedora02*, however there are some labels that remain from the *fedora01* source VM that will need to be manually updated.
+
image::2025_spring/module-04-storage/20_Cloned_VM_YAML.png[link=self, window=blank, width=100%]

. Modify the the *app* and *kubevirt.io/domain* values in the YAML so that they are set to *fedora02* then click the *Save* button at the bottom, you will prompted that *fedora02* has been updated to a new version. Doing this now will allow us to avoid issues working with this VM in later modules.
+
image::2025_spring/module-04-storage/21_Cloned_VM_YAML_Saved.png[link=self, window=blank, width=100%]

. When you have completed the modifications to the virtual machine's YAML go ahead and start it up so that you have both *fedora01* and *fedora02* running.
+
image::2025_spring/module-04-storage/22_Fedora02_Running.png[link=self, window=blank, width=100%]

== Summary

In this section of our lab we explored the storage options that are available when managing virtual machines. We also performed several VM management functions that are dependant on the storage provisioned for the virtual machine, including taking snapshots of VMs to peform basic restores, and cloning of VMs to be used in other projects or to help streamline future development.
